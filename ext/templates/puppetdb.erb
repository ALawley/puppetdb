#!/bin/bash

#############
# FUNCTIONS #
#############

# Display usage then exit
function usage {
  cat <<EOD
usage: $(basename $0) [--help] <command> [<args>]

The most commonly used puppetdb commands are:
EOD

  # Iterate and display commands in the libexec folder
  local files=<%= @libexec_dir -%>/puppetdb-*
  for f in $files; do
    local short=$(echo $(basename $f) | sed -e 's/puppetdb-//')
    echo "   ${short}"
  done

  cat << EOD

See '$(basename $0) <command> -h' for more information on a specific command.
EOD
  exit 0
}

# Execute the subcommand if available.
#
# $1 - subcommand
# $2 - arguments
#
# Example:
#
#   execsubcommand export -o test.dump -H 1.1.1.1
#
function execsubcommand {
  sub=$1
  shift
  args="$@"
  cmd="<%= @libexec_dir -%>/puppetdb-${sub}"

  if [ -x ${cmd} ]; then
    exec $cmd $args
  else
    echo "puppetdb: '${sub}' is not a puppetdb command. See '$(basename $0) --help'."
  fi
}

########
# MAIN #
########

if [ -z $1 ] || [ $1 = "--help" ] || [ $1 = "-h" ]; then
  usage
fi

sub=$1
shift
args="$@"

execsubcommand $sub $args
